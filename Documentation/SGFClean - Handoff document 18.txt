1. Project Vision & Current State
The Objective
To create a high-performance, aesthetically "clean" macOS native client forÂ Online Go Server (OGS). The project uses a custom SceneKit 3D viewport and a SwiftUI 2D board. It employs a hybrid architecture:
	â€¢	Swift Layer:Â Managing the WebSocket (Real-Time), REST API (Auth/Setup), and the SGF Engine (Move logic).
	â€¢	Web Layer:Â A backgroundÂ WKWebViewÂ that handles complex rendering or asset extraction (Tatami, Kaya board) while hiding the OGS web UI.
Current Status
The client has reached "Functional Parity" for live play:
	â€¢	Connection:Â Successful "Waterfall" initialization (REST -> WebSocket).
	â€¢	Lobby:Â Real-time challenge listing (Seekgraph) is functional.
	â€¢	Game Management:Â Can accept challenges, fetch initial board state, and sync handicap stones.
	â€¢	Live Moves:Â Outgoing moves (String format) are accepted by OGS. Incoming moves (Array format) are parsed and drawn correctly.

2. The "Truth Chain" Connection Protocol
The OGSÂ wsp.online-go.comÂ server is a modified Socket.io instance that is extremely sensitive to timing and formatting.
A. The Waterfall Initialization (Serial Execution Required)
You cannot open the WebSocket immediately. The client must follow this sequence to bind the socket to a valid session:
	1	Phase 1: Dummy POST:Â Send an empty JSON bodyÂ {}Â toÂ https://online-go.com/api/v0/login. This forces the server to set theÂ csrftokenÂ cookie in the app'sÂ HTTPCookieStorage.
	2	Phase 2: UI Config:Â Send a GET request toÂ https://online-go.com/api/v1/ui/config. This populates theÂ sessionidÂ cookie and retrieves theÂ user_jwt.
	3	Phase 3: WebSocket Handshake:Â Initiate the connection toÂ wss://wsp.online-go.com/.
	â—¦	Cookie Binding:Â TheÂ URLSessionÂ must share the sameÂ HTTPCookieStorageÂ from Phases 1 and 2.
	â—¦	Headers:Â Use a browser-likeÂ User-AgentÂ and set theÂ OriginÂ toÂ https://online-go.com.
B. The "No-Space" Rule (Brittle JSON Parsing)
OGS backend parsers are character-perfect. Standard SwiftÂ JSONSerializationÂ adds spaces after commas and colons.Â This causes silent authentication failures.
	â€¢	Requirement:Â Construct Auth and Move packets as raw interpolated strings.
	â€¢	Correct:Â ["authenticate",{"jwt":"..."}]
	â€¢	Incorrect:Â ["authenticate", {"jwt": "..."}]
C. The "42" Protocol Landmine
Standard Socket.io uses aÂ 42Â prefix for messages.
	â€¢	Critical Discovery:Â For the OGSÂ wspÂ server, adding theÂ 42Â prefix to Auth or Move packets causes an immediate transport-layer reset (nw_write_request_report ... Send failed).
	â€¢	Rule:Â UseÂ Plain WebSocketÂ framing. Packets must start with the raw bracketÂ [Â and end withÂ ].

3. Connection Survival & The "10-Second Rule"
OGS implements a strict timeout policy discovered in Handover v10.500.
The Heartbeat Logic
	1	Pulse Response:Â The server sends a raw stringÂ "2". The client must immediately respond with a raw stringÂ "3".
	2	Proactive Ping:Â If the server does not receive a pulse for ~10 seconds, it logically disconnects the player ("Your opponent is no longer connected"), even if the socket remains physically open.
	3	The Fix:Â We use aÂ pingTimerÂ set toÂ 7 secondsÂ to send a proactiveÂ "2"Â to the server, ensuring we beat the 10-second timeout.

4. Move Protocols & State Sync
Outgoing Moves (Client â†’ Server)
When the user clicks the board, the client sends a "Golden Payload":
	â€¢	Format:Â ["game/move", {payload}, msgID]
	â€¢	Payload Dictionary:
	â—¦	game_id: Integer.
	â—¦	move: SGF String (e.g.,Â "pd").
	â—¦	player_id: The current user's OGS ID.
	â—¦	blur: Random integer (800-3000) mimicking mouse hover time.
	â—¦	clock:Â {"main_time": 0, "timed_out": false}Â (mandatory metadata).
	â€¢	msgID:Â An incrementing integer appended to the end of the array.
Incoming Moves (Server â†’ Client)
Arrives asÂ ["game/{ID}/move", {payload}].
	â€¢	Payload:Â Typically an arrayÂ [x, y, server_time].
	â€¢	Normalization:Â OGSClientÂ converts the server's array back intoÂ [x, y]Â coordinates soÂ AppModelÂ can update theÂ SGFPlayerEngine.
The Handicap Move Bump
In handicap games, OGS often treats the handicap placement asÂ Move 1.
	â€¢	If a game has a handicap and the move count is 0, the client must set its internal counter to 1 so that the user's first click is sent asÂ Move 2. If Move 1 is sent twice, the server ignores it.

5. File Architecture & Responsibilities
File
Primary Responsibility
OGSClient.swift
The Brain.Â Manages Waterfall Init, Socket Heartbeats, and "No-Space" string formatting. Normalizes incoming server data.
AppModel.swift
The Coordinator.Â Orchestrates game joins, capturesÂ activeGameAuthÂ tokens, and handles audio/file persistence.
SGFPlayerEngine.swift
Source of Truth.Â The only file that calculates board state, captures, and liberties. Server-Authoritative.
BoardViewModel.swift
The Bridge.Â Translates Engine state intoÂ RenderStoneÂ objects for the UI. Handles "Ghost Stone" cursor tracking.
SceneManager3D.swift
Viewport Engine.Â Manages 3D textures, lighting, and "Drop-in" stone animations.
UnifiedInteractiveSceneView
Native Bridge.Â Handles high-DPI Retina coordinate conversion for 3D click detection.

6. Variables & Function Call Reference
Important Client Properties
	â€¢	isSocketAuthenticated: Boolean. Moves are suppressed until the server echoes anÂ authenticateÂ success event.
	â€¢	userJWT.didSet: TheÂ Watchdog. Automatically triggers authentication if the JWT arrives after the socket has already opened (fixes a common race condition).
	â€¢	latencyOffset: Calculated asÂ Date().now - server.now. Used to synchronize the countdown clocks.
	â€¢	availableGames: Array ofÂ OGSChallenge. Populated via theÂ seekgraph/globalÂ event.
Critical Function Calls
	â€¢	connectToGame(gameID): Must be called after joining. It subscribes to bothÂ game/connectÂ andÂ ui-pushes/subscribe.
	â€¢	ensureCSRFToken(): A wrapper used before REST POSTs (likeÂ acceptChallenge) to ensure the session cookies haven't expired.
	â€¢	sendRaw(text): The low-level socket writer. Bypasses standard JSON encoders to maintain character-perfection.

7. Known Landmines & Troubleshooting
"Ghost Stone appears but click does nothing"
	â€¢	Diagnosis:Â The socket is in a "Zombie" state. It is physically connected but the server ignored theÂ authenticateÂ packet because of spaces in the JSON or a missingÂ sessionidÂ cookie.
	â€¢	Check:Â Look forÂ âœ… OGS: Auth ConfirmedÂ in the console.
"NW Flow Failure / Socket is not connected"
	â€¢	Diagnosis:Â Protocol violation. You likely sent aÂ 42Â prefix or malformed JSON headers. The server hung up at the transport layer.
	â€¢	Check:Â Ensure all outgoing packets start with a rawÂ [Â bracket.
"Wrong Color Stones"
	â€¢	Diagnosis:Â The client failed to syncÂ blackPlayerIDÂ orÂ whitePlayerIDÂ from the initialÂ gamedataÂ packet.
	â€¢	Check:Â The client should logÂ ğŸ¨ OGS Identity SyncedÂ when entering a game.
"Console: open(/private/var/db/DetachedSignatures) failed"
	â€¢	Diagnosis:Â Safe noise. This is a standard macOS security log artifact and can be ignored.

Methodology for Next Session
	1	Maintain the Waterfall:Â Never connect the WebSocket before the REST config is verified.
	2	Maintain the 7s Heartbeat:Â Do not increase the ping interval beyond 10 seconds.
	3	Maintain Character-Perfection:Â Do not switch back toÂ JSONEncoderÂ for outgoing protocol-critical packets.
